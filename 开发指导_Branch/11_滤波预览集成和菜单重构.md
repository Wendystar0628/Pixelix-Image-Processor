# 11_滤波预览集成和菜单重构

## 修改概述

1. 集成滤波操作的实时预览功能
2. 重构菜单结构：将常规滤镜从滤波菜单中分离，形成三个并列菜单
3. 修复应用预设功能的逻辑问题

## 修改步骤

### 步骤1：扩展预览操作映射

**修改文件：** `app/core/services/persistence_service.py`
- 在OPERATION_CLASS_MAP中添加所有滤波操作的映射
- 确保滤波操作类名与字符串标识符的对应关系正确
- 清理任何重复或冲突的映射项

### 步骤2：更新预览管理器支持

**修改文件：** `app/core/engines/image_processor.py`
- 在render_pipeline方法中，确保preview_op_params能正确处理滤波操作
- 验证OPERATION_MAP包含所有新的滤波操作
- 添加对滤波操作预览失败的错误处理

### 步骤3：重构菜单结构

**修改文件：** `app/ui/managers/menu_manager.py`
- 删除现有的_create_filtering_menu方法
- 修改_create_point_op_menu方法，移除滤波相关菜单项
- 新增_create_spatial_filtering_menu方法，创建空间滤波独立菜单
- 新增_create_regular_filters_menu方法，创建常规滤镜独立菜单
- 在create_menus方法中调用新的菜单创建方法
- 确保菜单顺序为：文件、编辑、预设、工具、几何变换、点运算、空间滤波、常规滤镜

### 步骤4：修复应用预设功能

**修改文件：** `app/ui/dialogs/apply_preset_dialog.py`
- 检查get_selected_options方法的返回值格式
- 确保对话框正确处理预设选择和应用目标选择
- 修复预设列表的填充逻辑

**修改文件：** `app/ui/managers/dialog_manager.py`
- 检查_show_apply_preset_dialog方法中的预设应用逻辑
- 确保正确调用preset_handler的apply_preset方法
- 添加错误处理和用户反馈

**修改文件：** `app/handlers/preset_handler.py`
- 检查apply_preset方法的实现
- 确保预设加载和应用的完整流程
- 验证操作参数的正确传递

### 步骤5：验证滤波操作预览

**修改文件：** `app/handlers/processing_handler.py`
- 确保start_preview方法正确处理滤波操作的参数类型
- 验证滤波参数类能正确转换为字典格式
- 添加滤波操作预览的调试信息

### 步骤6：测试和验证

**创建测试文件：** `test_preview_and_preset.py`
- 测试滤波操作的实时预览功能
- 测试预设的保存、加载和应用功能
- 验证菜单结构的正确性
- 测试完成后删除测试文件

## 关键修改点

### 预览功能集成
- 确保所有滤波操作都在OPERATION_CLASS_MAP中注册
- 验证滤波参数类的__dict__方法能正确序列化
- 处理滤波操作预览时的异常情况

### 菜单结构重构
- 将"滤波"菜单拆分为"空间滤波"和"常规滤镜"两个独立菜单
- 保持菜单项的信号连接不变
- 确保图像依赖性actions的正确管理

### 预设功能修复
- 检查预设对话框的数据流
- 确保预设处理器的方法调用链完整
- 验证预设应用时的操作创建和执行

## 清理工作

- 删除旧的_create_filtering_menu方法
- 清理任何未使用的导入语句
- 移除调试打印语句
- 确保代码风格一致性

## 验证要点

1. 打开图像后，滤波菜单项应该可用
2. 调整滤波参数时应该有实时预览
3. 菜单结构应该是三个并列的处理菜单
4. 应用预设功能应该正常工作
5. 保存和删除预设功能保持正常