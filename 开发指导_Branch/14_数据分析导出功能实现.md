# 数据分析导出功能实现指导

## 功能概述

实现matplotlib数据分析图表的导出功能，支持原始数据导出和分析图表导出。在分析面板渲染引擎选择器旁边添加"导出数据分析"按钮，支持批量导出所有作业中所有图像的数据分析结果。

## 导出功能特性

### 导出类型
1. **分析图表导出** - PNG/JPEG/SVG格式的图表图像
2. **原始数据导出** - JSON/CSV/XLSX格式的分析数据

### 支持的数据分析项目（六项）
1. **彩色直方图** - RGB三通道直方图分布
2. **亮度波形图** - 图像亮度分布波形
3. **RGB Parade** - RGB三通道波形图
4. **色相** - HSV色相通道直方图
5. **饱和度** - HSV饱和度通道直方图
6. **Lab 2D散点图** - Lab色彩空间a*b*色度散点图（不包括3D）

### 导出范围
- 支持选择特定的数据分析图表类型
- 批量导出所有作业中的所有图像
- 按作业分组组织导出结果

### 文件组织结构
```
数据分析_YYYYMMDD_HHMMSS/
├── 作业名称1/
│   ├── 图像1_彩色直方图.png
│   ├── 图像1_彩色直方图_数据.csv
│   ├── 图像1_亮度波形图.png
│   ├── 图像1_亮度波形图_数据.csv
│   ├── 图像1_RGB_Parade.png
│   ├── 图像1_RGB_Parade_数据.csv
│   ├── 图像1_色相.png
│   ├── 图像1_色相_数据.csv
│   ├── 图像1_饱和度.png
│   ├── 图像1_饱和度_数据.csv
│   ├── 图像1_Lab_2D散点图.png
│   ├── 图像1_Lab_2D散点图_数据.csv
│   └── ...
├── 作业名称2/
│   └── ...
```

## 实现步骤

### 步骤1：创建数据分析导出配置模型

**新建文件：** `app/core/models/analysis_export_config.py`
- 定义AnalysisExportType枚举：COLOR_HISTOGRAM, LUMA_WAVEFORM, RGB_PARADE, HUE_HISTOGRAM, SATURATION_HISTOGRAM, LAB_2D_SCATTER
- 定义AnalysisDataFormat枚举：JSON, CSV, XLSX
- 定义AnalysisChartFormat枚举：PNG, JPEG, SVG
- 创建AnalysisExportConfig数据类：
  - export_path: str - 导出根路径
  - selected_analysis_types: List[AnalysisExportType] - 选择的分析类型
  - chart_format: AnalysisChartFormat - 图表格式
  - data_format: AnalysisDataFormat - 数据格式
  - chart_quality: int - 图表质量（JPEG用）
  - include_raw_data: bool - 是否包含原始数据

### 步骤2：创建数据分析导出对话框

**新建文件：** `app/ui/dialogs/analysis_export_dialog.py`
- 创建AnalysisExportDialog类继承QDialog
- 实现UI布局：
  - 导出路径选择区域
  - 分析类型选择区域（复选框组）
  - 图表格式选择区域
  - 原始数据格式选择区域
  - 质量设置区域
  - 确认和取消按钮
- 实现路径选择逻辑
- 实现配置验证逻辑
- 返回AnalysisExportConfig对象

### 步骤3：创建数据分析导出服务

**新建文件：** `app/core/services/analysis_export_service.py`
- 创建AnalysisExportService类
- 实现export_analysis_data方法：
  - 遍历所有作业和图像
  - 为每个图像生成分析数据
  - 按配置导出图表和数据文件
- 实现_create_export_directory_structure方法
- 实现_export_chart_image方法（matplotlib图表保存）
- 实现_export_raw_data方法（JSON/CSV/XLSX数据保存）
- 实现_generate_analysis_for_image方法
- 添加进度回调支持

### 步骤4：创建matplotlib图表导出工具

**新建文件：** `app/utils/matplotlib_export_utils.py`
- 创建MatplotlibExportUtils类
- 实现save_figure_to_file方法：
  - 支持PNG/JPEG/SVG格式
  - 保持与界面显示一致的质量
  - 处理中文字体和编码
- 实现get_figure_from_widget方法
- 实现optimize_figure_for_export方法
- 处理不同格式的特定参数

### 步骤5：创建数据格式转换工具

**新建文件：** `app/utils/analysis_data_converter.py`
- 创建AnalysisDataConverter类
- 实现to_json方法：转换分析数据为JSON格式
- 实现to_csv方法：转换分析数据为CSV格式
- 实现to_xlsx方法：转换分析数据为Excel格式
- 实现_format_color_histogram_data方法
- 实现_format_luma_waveform_data方法
- 实现_format_rgb_parade_data方法
- 实现_format_hue_histogram_data方法
- 实现_format_saturation_histogram_data方法
- 实现_format_lab_2d_scatter_data方法

### 步骤6：扩展分析面板UI

**修改文件：** `app/ui/panels/analysis_panel.py`
- 在_create_engine_selector方法中添加导出按钮
- 在引擎选择器布局中添加"导出数据分析"按钮
- 连接按钮点击事件到_on_export_analysis_clicked方法
- 实现_on_export_analysis_clicked方法：
  - 创建并显示AnalysisExportDialog
  - 获取用户配置
  - 调用导出服务

### 步骤7：扩展分析引擎支持导出

**修改文件：** `app/core/engines/image_analysis_engine.py`
- 添加calculate_analysis_for_export方法
- 支持为指定图像计算特定类型的分析数据
- 优化批量计算性能
- 添加进度回调支持

### 步骤8：创建导出进度对话框

**新建文件：** `app/ui/dialogs/analysis_export_progress_dialog.py`
- 创建AnalysisExportProgressDialog类继承QDialog
- 显示导出进度条
- 显示当前处理的文件信息
- 支持取消操作
- 显示导出完成统计

### 步骤9：扩展状态管理器支持批量分析

**修改文件：** `app/core/managers/state_manager.py`
- 添加get_all_jobs_with_images方法
- 返回所有作业及其包含的图像列表
- 支持按作业分组的图像访问

### 步骤10：扩展matplotlib分析控件支持导出

**修改文件：** `app/ui/widgets/lab_analysis_widget.py`
- 添加get_figure方法返回matplotlib Figure对象
- 添加export_to_file方法直接导出图表
- 确保图表质量与显示一致

**修改文件：** `app/ui/widgets/histogram_widget.py`
- 添加get_figure方法返回matplotlib Figure对象
- 添加export_to_file方法直接导出彩色直方图

**修改文件：** `app/ui/widgets/luma_waveform_widget.py`
- 添加get_figure方法返回matplotlib Figure对象
- 添加export_to_file方法直接导出亮度波形图

**修改文件：** `app/ui/widgets/rgb_parade_widget.py`
- 添加get_figure方法返回matplotlib Figure对象
- 添加export_to_file方法直接导出RGB Parade图

**修改文件：** `app/ui/widgets/hue_saturation_widget.py`
- 添加get_hue_figure和get_saturation_figure方法分别返回色相和饱和度的Figure对象
- 添加export_hue_to_file和export_saturation_to_file方法分别导出色相和饱和度图表

**修改文件：** `app/ui/widgets/combined_analysis_widget.py`
- 添加get_histogram_figure和get_luma_waveform_figure方法
- 通过子控件获取对应的Figure对象

### 步骤11：集成导出功能到主应用

**修改文件：** `app/ui/managers/dialog_manager.py`
- 添加show_analysis_export_dialog方法
- 管理导出对话框的生命周期

**修改文件：** `app/handlers/app_controller.py`
- 添加export_analysis_data方法
- 协调导出服务和UI组件

### 步骤12：添加导出配置持久化

**修改文件：** `app/core/services/persistence_service.py`
- 添加save_analysis_export_config方法
- 添加load_analysis_export_config方法
- 支持用户导出偏好设置的保存和加载

## 关键技术实现

### matplotlib图表导出质量控制
- 使用与界面显示相同的DPI设置
- 保持图表尺寸和字体大小一致
- 处理中文字体渲染问题
- 优化SVG格式的文件大小

### 批量处理性能优化
- 使用多线程处理图像分析
- 实现分析数据缓存机制
- 优化内存使用避免OOM
- 提供进度反馈和取消功能

### 数据格式转换
- JSON格式保持数据结构完整性
- CSV格式优化表格数据展示
- XLSX格式支持多工作表和格式化
- 处理大数据集的内存效率

### 文件组织和命名
- 按时间戳创建根目录避免冲突
- 按作业名称组织子目录
- 使用"原图名称_分析项目名称"的命名规范
- 处理文件名特殊字符和长度限制

## 文件修改清单

### 新建文件
- `app/core/models/analysis_export_config.py` - 导出配置模型
- `app/ui/dialogs/analysis_export_dialog.py` - 导出配置对话框
- `app/core/services/analysis_export_service.py` - 导出服务核心逻辑
- `app/utils/matplotlib_export_utils.py` - matplotlib导出工具
- `app/utils/analysis_data_converter.py` - 数据格式转换工具
- `app/ui/dialogs/analysis_export_progress_dialog.py` - 导出进度对话框

### 修改文件
- `app/ui/panels/analysis_panel.py` - 添加导出按钮和事件处理
- `app/core/engines/image_analysis_engine.py` - 支持批量分析计算
- `app/core/managers/state_manager.py` - 支持批量作业访问
- `app/ui/widgets/lab_analysis_widget.py` - 添加导出支持
- `app/ui/widgets/histogram_widget.py` - 添加彩色直方图导出支持
- `app/ui/widgets/luma_waveform_widget.py` - 添加亮度波形图导出支持
- `app/ui/widgets/rgb_parade_widget.py` - 添加RGB Parade导出支持
- `app/ui/widgets/hue_saturation_widget.py` - 添加色相和饱和度分别导出支持
- `app/ui/widgets/combined_analysis_widget.py` - 添加组合控件导出支持
- `app/ui/managers/dialog_manager.py` - 管理导出对话框
- `app/handlers/app_controller.py` - 协调导出功能
- `app/core/services/persistence_service.py` - 配置持久化

## 数据流程

1. **用户触发导出**：点击"导出数据分析"按钮
2. **配置收集**：显示导出配置对话框，收集用户选择
3. **作业遍历**：获取所有作业和图像列表
4. **批量分析**：为每个图像计算选定的分析数据
5. **文件导出**：按配置导出图表和数据文件
6. **进度反馈**：显示导出进度和完成状态

## 测试验证

- 测试不同图表格式的导出质量
- 验证批量导出的性能和稳定性
- 检查文件组织结构的正确性
- 测试大量图像的内存使用情况
- 验证数据格式转换的准确性
- 测试导出过程的取消和错误处理

## 注意事项

- 确保导出的图表质量与界面显示一致
- 处理大批量导出时的内存管理
- 提供清晰的进度反馈和错误信息
- 支持导出过程的中断和恢复
- 考虑不同操作系统的文件路径兼容性
- 处理文件名冲突和特殊字符问题