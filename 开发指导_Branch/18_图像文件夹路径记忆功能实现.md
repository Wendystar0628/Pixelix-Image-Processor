# 18_图像文件夹路径记忆功能实现

## 功能需求
实现图像池"添加图像"功能的文件夹路径记忆，记录用户上次打开的文件夹位置，在下次点击"添加图像"时自动定位到该路径，支持软件重启后的路径持久化。

## 实现步骤

### 1. 扩展配置模型
**文件**: `app/models/app_config.py`
- 在AppConfig类中添加`last_image_folder_path: Optional[str] = None`字段
- 在`__post_init__`方法中添加路径有效性验证逻辑

### 2. 修改图像池面板的文件选择逻辑
**文件**: `app/ui/panels/batch_processing_panel/image_pool_panel.py`
- 修改`_on_add_images_clicked`方法中的QFileDialog.getOpenFileNames调用
- 将硬编码的空字符串路径替换为从配置服务获取的上次文件夹路径
- 在文件选择成功后，保存新的文件夹路径到配置

### 3. 扩展批处理协调器接口
**文件**: `app/features/batch_processing/batch_coordinator.py`
- 添加`get_last_image_folder_path`方法，返回配置中的上次图像文件夹路径
- 添加`save_image_folder_path`方法，保存新的图像文件夹路径到配置
- 确保这些方法通过配置服务访问AppConfig

### 4. 修改图像池面板的依赖注入
**文件**: `app/ui/panels/batch_processing_panel/image_pool_panel.py`
- 在构造函数中确保能够访问配置服务
- 通过handler获取配置相关的方法

### 5. 更新批处理接口定义
**文件**: `app/features/batch_processing/interfaces/batch_processing_interface.py`
- 在BatchProcessingInterface中添加图像文件夹路径相关的抽象方法声明
- 确保接口的完整性和一致性

### 6. 扩展配置服务功能
**文件**: `app/layers/infrastructure/configuration/config_service.py`
- 确保ConfigService的update_config方法支持last_image_folder_path字段的更新
- 验证配置更新和持久化机制正常工作

### 7. 修改配置数据访问器
**文件**: `app/layers/infrastructure/configuration/config_data_accessor.py`
- 添加`get_last_image_folder_path`方法
- 确保方法返回正确的配置值

## 技术要点

### 路径记忆逻辑
- 在用户选择文件后，提取文件路径的目录部分
- 通过配置服务保存到AppConfig.last_image_folder_path
- 下次打开文件对话框时，使用保存的路径作为初始目录

### 路径有效性处理
- 在配置加载时验证路径是否存在
- 如果路径不存在，使用空字符串作为默认值
- 确保不会因为无效路径导致文件对话框异常

### 配置持久化
- 利用现有的配置管理机制
- 确保路径变更能够立即保存到配置文件
- 支持软件重启后的路径恢复

## 影响范围

### 直接修改文件
1. `app/models/app_config.py` - 添加配置字段
2. `app/ui/panels/batch_processing_panel/image_pool_panel.py` - 修改文件选择逻辑
3. `app/features/batch_processing/batch_coordinator.py` - 添加路径管理方法
4. `app/features/batch_processing/interfaces/batch_processing_interface.py` - 扩展接口
5. `app/layers/infrastructure/configuration/config_data_accessor.py` - 添加访问方法

### 验证文件
1. `app/layers/infrastructure/configuration/config_service.py` - 确认更新机制
2. `app/layers/infrastructure/configuration/config_manager.py` - 确认持久化机制

## 测试验证
- 验证首次使用时文件对话框的默认行为
- 验证选择文件后路径记忆功能
- 验证软件重启后路径恢复功能
- 验证无效路径的处理机制