# 17_导出路径记忆功能实现

## 功能需求
实现图像批处理导出和数据分析导出的路径记忆功能。当用户导出一次后，记录导出路径到配置文件，软件重启后自动选择上次导出的路径。两种导出类型的路径分别记录和更新。

## 实现步骤

### 第一阶段：配置模型扩展

#### 1.1 修改 `app/models/app_config.py`
- 在AppConfig类中添加导出路径记忆字段
- 添加 `last_batch_export_path: Optional[str] = None` 字段记录批处理导出路径
- 添加 `last_analysis_export_path: Optional[str] = None` 字段记录数据分析导出路径
- 在__post_init__方法中添加路径有效性验证逻辑

### 第二阶段：批处理导出路径记忆

#### 2.1 修改 `app/ui/dialogs/export_options/export_options_dialog.py`
- 在对话框初始化时从配置服务获取上次批处理导出路径
- 如果路径存在且有效，设置为默认路径
- 在用户确认导出时，将选择的路径保存到配置
- 添加配置服务依赖注入到构造函数

#### 2.2 修改批处理导出调用点
- 在 `app/ui/panels/batch_processing_panel/main_panel.py` 中修改导出对话框创建逻辑
- 传入配置服务实例到导出选项对话框
- 确保导出完成后配置被正确保存

### 第三阶段：数据分析导出路径记忆

#### 3.1 修改 `app/ui/dialogs/analysis_export_dialog.py`
- 在对话框初始化时从配置服务获取上次数据分析导出路径
- 如果路径存在且有效，设置为默认路径
- 在用户确认导出时，将选择的路径保存到配置
- 添加配置服务依赖注入到构造函数

#### 3.2 修改数据分析导出调用点
- 在 `app/ui/panels/analysis_panel.py` 中修改导出对话框创建逻辑
- 传入配置服务实例到数据分析导出对话框
- 确保导出完成后配置被正确保存

### 第四阶段：配置服务集成

#### 4.1 确保配置服务可访问性
- 检查 `app/handlers/app_controller.py` 是否提供配置服务访问方法
- 如果没有，添加 `get_config_service()` 方法
- 确保配置服务在应用启动时正确初始化

#### 4.2 路径有效性验证
- 在设置默认路径前验证路径是否存在
- 如果路径不存在，回退到系统默认路径（如用户文档目录）
- 添加路径权限检查，确保可写入

### 第五阶段：用户体验优化

#### 5.1 路径显示优化
- 在路径输入框中显示完整路径
- 添加路径有效性的视觉反馈
- 如果使用记忆路径，在界面上给出提示

#### 5.2 配置持久化
- 确保配置在导出操作完成后立即保存
- 添加配置保存失败的错误处理
- 在应用关闭时确保配置被正确保存

## 关键文件修改清单

### 需要修改的文件
1. `app/models/app_config.py` - 添加导出路径记忆字段
2. `app/ui/dialogs/export_options/export_options_dialog.py` - 实现批处理导出路径记忆
3. `app/ui/dialogs/analysis_export_dialog.py` - 实现数据分析导出路径记忆
4. `app/ui/panels/batch_processing_panel/main_panel.py` - 修改导出对话框调用
5. `app/ui/panels/analysis_panel.py` - 修改导出对话框调用
6. `app/handlers/app_controller.py` - 确保配置服务可访问（如需要）

### 需要新建的文件
无需新建文件，所有功能通过现有文件扩展实现

### 需要删除的逻辑
无需删除现有逻辑，只需扩展功能

## 实现注意事项

### 架构一致性
- 遵循现有的配置管理模式
- 使用现有的配置服务接口
- 保持UI层和配置层的清晰分离

### 向后兼容性
- 新增配置字段使用Optional类型，确保旧配置文件兼容
- 路径不存在时优雅降级到默认行为
- 保持现有导出功能的完整性

### 用户体验
- 路径记忆应该是透明的，不影响用户正常操作
- 提供清晰的路径状态反馈
- 确保路径选择的便利性和准确性

### 错误处理
- 处理路径不存在或无权限的情况
- 配置保存失败时的降级处理
- 添加适当的日志记录用于调试

## 测试验证要点

### 功能测试
- 验证批处理导出路径记忆功能
- 验证数据分析导出路径记忆功能
- 验证软件重启后路径恢复
- 验证两种导出类型路径独立记录

### 边界测试
- 测试路径不存在的情况
- 测试路径无权限的情况
- 测试配置文件损坏的情况
- 测试首次使用（无历史路径）的情况

### 兼容性测试
- 验证旧配置文件的兼容性
- 验证配置升级的正确性
- 验证不同操作系统路径格式的兼容性