# 步骤1：数据分析导出多作业选择功能实现指导

## 概述
将当前的数据分析导出功能从单一"当前作业"模式改为支持用户选择多个作业进行导出，并为每个选中作业创建独立的子文件夹。

## 核心需求
1. 用户可在导出对话框中选择要导出的作业
2. 至少选中一个作业才能导出
3. 默认选中列表第一个作业
4. 无作业时禁用导出按钮并提示"请先新建作业"
5. 在"数据分析_当前时间"文件夹下为每个作业创建以作业名称命名的子文件夹

## 实施步骤

### 第一阶段：数据模型扩展

#### 1.1 修改 `analysis_export_config.py`
- 添加 `selected_job_ids: List[str]` 字段存储选中的作业ID列表
- 添加 `job_selection_mode: bool` 字段标识是否启用作业选择模式
- 保持向后兼容性，默认为单作业模式

#### 1.2 创建作业选择数据模型
- 新建 `app/core/models/job_selection_model.py`
- 定义 `JobSelectionItem` 类包含作业ID、名称、图像数量等信息
- 定义 `JobSelectionConfig` 类管理作业选择状态

### 第二阶段：UI组件重构

#### 2.1 修改 `analysis_export_dialog.py`
- 在构造函数中注入批处理协调器依赖
- 添加作业选择区域UI组件（QListWidget或QCheckBox列表）
- 修改 `_init_ui()` 方法添加作业选择区域
- 实现作业列表加载和状态管理逻辑
- 添加作业选择验证逻辑
- 修改导出按钮状态控制逻辑

#### 2.2 新增作业选择组件
- 创建 `app/ui/widgets/job_selection_widget.py`
- 实现可复用的作业选择控件
- 支持单选/多选模式切换
- 提供作业信息显示（名称、图像数量等）

### 第三阶段：服务层改造

#### 3.1 修改 `analysis_export_service.py`
- 重构 `_get_all_jobs_with_images()` 方法使用批处理协调器获取真实作业数据
- 修改 `export_analysis()` 方法支持多作业导出
- 实现按作业分组的目录结构创建逻辑
- 添加作业级别的导出进度跟踪
- 保持单作业模式的向后兼容性

#### 3.2 扩展导出目录结构
- 修改目录创建逻辑：`数据分析_时间戳/作业名称/图像分析文件`
- 处理作业名称中的特殊字符和重名情况
- 确保目录创建的原子性和错误处理

### 第四阶段：集成和调用修改

#### 4.1 修改菜单和对话框调用
- 在 `menu_manager.py` 中添加数据分析导出菜单项（如果不存在）
- 修改 `dialog_manager.py` 添加数据分析导出对话框处理
- 在 `app_controller.py` 中添加数据分析导出功能调用
- 实现作业状态检查和按钮禁用逻辑

#### 4.2 依赖注入调整
- 修改对话框创建时的依赖注入，传入批处理协调器
- 确保批处理功能可用性检查
- 处理批处理功能未初始化的降级方案

### 第五阶段：清理和优化

#### 5.1 移除旧逻辑
- 清理 `analysis_export_service.py` 中的模拟数据逻辑
- 移除硬编码的"当前作业"创建逻辑
- 统一使用批处理协调器的作业管理接口

#### 5.2 错误处理和用户体验
- 添加作业选择为空时的友好提示
- 实现导出过程中的进度显示
- 添加导出完成后的结果反馈
- 处理作业数据不一致的异常情况

## 关键文件修改清单

### 需要修改的文件
1. `app/core/models/analysis_export_config.py` - 扩展配置模型
2. `app/ui/dialogs/analysis_export_dialog.py` - 重构对话框UI和逻辑
3. `app/core/services/analysis_export_service.py` - 改造导出服务
4. `app/ui/managers/dialog_manager.py` - 添加对话框处理
5. `app/ui/managers/menu_manager.py` - 添加菜单项（如需要）
6. `app/handlers/app_controller.py` - 添加功能调用

### 需要新建的文件
1. `app/core/models/job_selection_model.py` - 作业选择数据模型
2. `app/ui/widgets/job_selection_widget.py` - 作业选择控件

### 需要删除的逻辑
1. `analysis_export_service.py` 中的模拟作业数据创建
2. 硬编码的"当前作业"文件夹创建逻辑
3. 基于单一图像的导出路径生成逻辑

## 实现注意事项

### 架构一致性
- 遵循现有的依赖注入模式
- 保持UI层、服务层、数据层的清晰分离
- 使用现有的信号槽机制进行组件通信

### 向后兼容性
- 保持现有配置结构的兼容性
- 支持无批处理功能时的降级处理
- 确保单图像模式仍然可用

### 用户体验
- 提供清晰的作业选择界面
- 实现合理的默认选择行为
- 添加适当的加载和进度提示
- 确保错误信息的友好性

### 性能考虑
- 避免频繁的作业列表刷新
- 实现增量式的UI更新
- 优化大量作业时的界面响应性

## 验收标准
1. 用户可以在导出对话框中看到所有可用作业
2. 默认选中第一个作业
3. 至少选中一个作业才能进行导出
4. 无作业时导出按钮被禁用并显示提示
5. 导出后在指定目录下创建以作业名称命名的子文件夹
6. 每个作业的分析图表正确导出到对应文件夹
7. 保持原有单图像导出功能的正常工作
8. 错误处理和用户提示完善