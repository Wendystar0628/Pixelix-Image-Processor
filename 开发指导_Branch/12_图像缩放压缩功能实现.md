# 图像缩放压缩功能实现指导

## 功能概述

实现图像的放大、缩小和压缩功能，每类功能包含5种常见算法，集成到菜单栏并支持实时预览。

## 菜单布局设计

新增的三个菜单将与现有菜单并列显示：

```
菜单栏布局：
文件 | 编辑 | 预设 | 工具 | 几何变换 | 点运算 | 滤波 | 图像放大 | 图像缩小 | 图像压缩
```

每个新菜单包含5个算法选项：
- **图像放大菜单**：最近邻插值、双线性插值、双三次插值、Lanczos插值、边缘保持插值
- **图像缩小菜单**：最近邻下采样、双线性下采样、区域平均下采样、高斯下采样、抗锯齿下采样
- **图像压缩菜单**：JPEG质量压缩、PNG压缩级别、WebP压缩、颜色量化压缩、有损压缩优化

## 算法分类

### 图像放大算法（插值）
1. 最近邻插值 - 速度最快，质量较低
2. 双线性插值 - 平衡速度和质量
3. 双三次插值 - 质量较高，速度中等
4. Lanczos插值 - 高质量，边缘保持好
5. 边缘保持插值 - 保持边缘清晰度

### 图像缩小算法（下采样）
1. 最近邻下采样 - 速度最快
2. 双线性下采样 - 平滑效果好
3. 区域平均下采样 - 保持细节
4. 高斯下采样 - 抗锯齿效果好
5. 抗锯齿下采样 - 最佳质量

### 图像压缩算法
1. JPEG质量压缩 - 调整JPEG质量参数
2. PNG压缩级别 - 调整PNG压缩级别
3. WebP压缩 - 现代压缩格式
4. 颜色量化压缩 - 减少颜色数量
5. 有损压缩优化 - 智能质量优化

## 实现步骤

### 步骤1：创建参数数据模型

**新建文件：** `app/core/models/scale_up_params.py`
- 创建ScaleUpParams数据类：scale_factor, algorithm
- 支持5种放大算法的参数配置

**新建文件：** `app/core/models/scale_down_params.py`
- 创建ScaleDownParams数据类：scale_factor, algorithm
- 支持5种缩小算法的参数配置

**新建文件：** `app/core/models/compression_params.py`
- 创建CompressionParams数据类：quality, format, algorithm
- 支持5种压缩算法的参数配置

### 步骤2：实现缩放和压缩操作类

**新建目录：** `app/core/operations/image_scaling/`

**新建文件：** `app/core/operations/image_scaling/__init__.py`
- 导出所有缩放操作类

**新建文件：** `app/core/operations/image_scaling/scale_up_ops.py`
- 创建NearestScaleUpOp类：最近邻插值放大
- 创建BilinearScaleUpOp类：双线性插值放大
- 创建BicubicScaleUpOp类：双三次插值放大
- 创建LanczosScaleUpOp类：Lanczos插值放大
- 创建EdgePreservingScaleUpOp类：边缘保持插值放大

**新建文件：** `app/core/operations/image_scaling/scale_down_ops.py`
- 创建NearestScaleDownOp类：最近邻下采样
- 创建BilinearScaleDownOp类：双线性下采样
- 创建AreaAverageScaleDownOp类：区域平均下采样
- 创建GaussianScaleDownOp类：高斯下采样
- 创建AntiAliasScaleDownOp类：抗锯齿下采样

**新建目录：** `app/core/operations/image_compression/`

**新建文件：** `app/core/operations/image_compression/__init__.py`
- 导出所有压缩操作类

**新建文件：** `app/core/operations/image_compression/compression_ops.py`
- 创建JpegCompressionOp类：JPEG质量压缩
- 创建PngCompressionOp类：PNG压缩级别
- 创建WebpCompressionOp类：WebP压缩
- 创建ColorQuantizationOp类：颜色量化压缩
- 创建LossyOptimizationOp类：有损压缩优化

### 步骤3：更新操作注册表

**修改文件：** `app/core/operations/registry.py`
- 导入所有新的缩放和压缩操作类
- 在OPERATION_REGISTRY中注册所有新操作类（共15个操作）

### 步骤4：创建参数调整对话框

**新建目录：** `app/ui/dialogs/image_scaling/`

**新建文件：** `app/ui/dialogs/image_scaling/__init__.py`
- 导出所有缩放对话框类

**新建文件：** `app/ui/dialogs/image_scaling/scale_up_dialog.py`
- 创建ScaleUpDialog类：缩放因子滑块、算法选择下拉框
- 支持5种放大算法选择
- 继承BaseOperationDialog，支持实时预览

**新建文件：** `app/ui/dialogs/image_scaling/scale_down_dialog.py`
- 创建ScaleDownDialog类：缩放因子滑块、算法选择下拉框
- 支持5种缩小算法选择
- 继承BaseOperationDialog，支持实时预览

**新建目录：** `app/ui/dialogs/image_compression/`

**新建文件：** `app/ui/dialogs/image_compression/__init__.py`
- 导出所有压缩对话框类

**新建文件：** `app/ui/dialogs/image_compression/compression_dialog.py`
- 创建CompressionDialog类：质量滑块、格式选择、算法选择
- 支持5种压缩算法选择
- 显示预估文件大小
- 继承BaseOperationDialog，支持实时预览

### 步骤5：扩展菜单管理器

**修改文件：** `app/ui/managers/menu_manager.py`
- 在create_menus方法中添加三个新菜单创建调用：
  - `_create_scale_up_menu(menu_bar)`
  - `_create_scale_down_menu(menu_bar)`
  - `_create_compression_menu(menu_bar)`
- 实现_create_scale_up_menu方法：
  - 创建"图像放大"主菜单（与"点运算"、"滤波"并列）
  - 添加5个放大算法菜单项
  - 为每个算法添加信号连接
- 实现_create_scale_down_menu方法：
  - 创建"图像缩小"主菜单（与其他菜单并列）
  - 添加5个缩小算法菜单项
  - 为每个算法添加信号连接
- 实现_create_compression_menu方法：
  - 创建"图像压缩"主菜单（与其他菜单并列）
  - 添加5个压缩算法菜单项
  - 为每个算法添加信号连接

### 步骤6：扩展对话框管理器

**修改文件：** `app/ui/managers/dialog_manager.py`
- 导入所有新的变换对话框类
- 在_dialog_map中添加15个新对话框映射（每个算法一个对话框）
- 确保对话框正确集成到现有生命周期管理

### 步骤7：扩展处理器路由

**修改文件：** `app/handlers/processing_handler.py`
- 导入所有新的操作类和参数类
- 添加15个apply方法（每个算法一个方法）
- 实现参数处理和命令创建逻辑
- 在apply_simple_operation路由表中添加相应映射

### 步骤8：集成预览支持

**修改文件：** `app/core/managers/preview_manager.py`
- 在PREVIEW_OPERATION_MAP中添加三个新操作映射
- 确保变换操作支持实时预览
- 处理大图像的预览优化

### 步骤9：更新UI状态管理

**修改文件：** `app/ui/managers/ui_state_manager.py`
- 确保新菜单项正确注册为图像依赖操作
- 添加变换操作的状态管理逻辑

### 步骤10：测试和验证

**新建文件：** `test_transform_functionality.py`（临时测试文件）
- 测试操作类的基本功能
- 测试参数类的序列化
- 测试对话框的创建和参数传递
- 测试菜单到操作的完整流程
- 验证预览功能正常工作

## 关键设计考虑

### 性能优化
- 大图像变换时显示进度指示
- 预览模式使用降采样图像
- 缓存常用的变换结果

### 用户体验
- 提供预设的常用缩放比例（50%, 75%, 125%, 150%, 200%）
- 压缩对话框显示预估文件大小
- 实时预览变换效果

### 错误处理
- 验证缩放因子范围（0.1-10.0）
- 检查内存限制，防止过大图像处理
- 处理不支持的图像格式

### 架构合规性
- 严格遵循现有的四层架构
- 操作类保持无状态设计
- 通过依赖注入获取服务
- 使用命令模式支持撤销重做

## 文件修改清单

### 新建文件

**参数数据模型：**
- `app/core/models/scale_up_params.py` - 图像放大参数模型
- `app/core/models/scale_down_params.py` - 图像缩小参数模型
- `app/core/models/compression_params.py` - 图像压缩参数模型

**操作类实现：**
- `app/core/operations/image_scaling/__init__.py` - 缩放操作导出
- `app/core/operations/image_scaling/scale_up_ops.py` - 5个放大操作类
- `app/core/operations/image_scaling/scale_down_ops.py` - 5个缩小操作类
- `app/core/operations/image_compression/__init__.py` - 压缩操作导出
- `app/core/operations/image_compression/compression_ops.py` - 5个压缩操作类

**对话框实现：**
- `app/ui/dialogs/image_scaling/__init__.py` - 缩放对话框导出
- `app/ui/dialogs/image_scaling/scale_up_dialog.py` - 放大参数对话框
- `app/ui/dialogs/image_scaling/scale_down_dialog.py` - 缩小参数对话框
- `app/ui/dialogs/image_compression/__init__.py` - 压缩对话框导出
- `app/ui/dialogs/image_compression/compression_dialog.py` - 压缩参数对话框

### 修改文件
- `app/core/operations/registry.py` - 注册15个新操作
- `app/ui/managers/menu_manager.py` - 添加三个并列的变换菜单
- `app/ui/managers/dialog_manager.py` - 集成15个新对话框
- `app/handlers/processing_handler.py` - 添加15个处理方法
- `app/core/managers/preview_manager.py` - 支持变换预览
- `app/ui/managers/ui_state_manager.py` - 状态管理更新

## 实现优先级

1. **高优先级**：基础缩放功能（最近邻、双线性插值）
2. **中优先级**：高质量插值算法（双三次、Lanczos）
3. **低优先级**：高级功能（边缘保持插值、智能压缩）

## 注意事项

- 所有新文件名保持项目唯一性
- 遵循现有的命名规范和代码风格
- 确保新功能与现有预设系统兼容
- 变换操作支持批处理功能
- 考虑大图像处理的内存管理