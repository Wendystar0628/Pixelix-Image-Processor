# 技术设计文档：PyQtGraph性能优化方案

## 1. 架构概述

为解决UI卡顿问题，我们将对当前的分析面板（Analysis Panel）进行重构。核心思想是**将重量级的计算任务与UI更新分离**，并**复用UI控件**。

新的架构将遵循以下原则：
1.  **UI控件池化/复用**: 在程序启动或首次加载图像时，一次性创建所有PyQtGraph分析图表控件，并将它们放入一个`QStackedWidget`中进行管理。切换图表时，仅改变`QStackedWidget`的当前显示页面，而不是销毁和重建控件。
2.  **异步计算**: 将数据分析计算（如直方图、波形图等）移至一个专用的后台工作线程（`QThread`）中执行。
3.  **信号与槽驱动更新**: UI主线程通过信号（Signal）请求后台线程进行计算。计算完成后，后台线程通过信号将结果发送回主线程，主线程中的槽函数（Slot）接收到结果后，安全地更新对应的UI控件。

### 2.1. 核心组件设计

#### 2.1.1. `AnalysisPanel` (UI管理器)
-   **职责**: 管理所有分析图表控件的生命周期和可见性。
-   **修改点**:
    -   内部将使用`QStackedWidget`来容纳所有的PyQtGraph图表实例（`PyQtGraphHistogramWidget`, `PyQtGraphRgbParadeWidget`等）。
    -   提供一个公共方法 `switch_view(view_name)`，该方法仅调用`QStackedWidget.setCurrentWidget()`来切换视图，实现O(1)复杂度的快速切换。
    -   连接用户操作（如按钮点击）到 `request_analysis(analysis_type)` 方法。

#### 2.1.2. `AnalysisWorker` (后台计算单元)
-   **职责**: 在后台线程中执行所有耗时的数据分析计算。
-   **设计**:
    -   创建一个新的`QObject`子类`AnalysisWorker`。
    -   它包含一个槽函数 `do_analysis(image_data, analysis_type)`，用于接收计算请求。
    -   它包含一个信号 `analysis_complete(result_data, analysis_type)`，用于在计算完成后将结果发送出去。
    -   在应用启动时，`AnalysisWorker`的实例将被移动到（`moveToThread`）一个长期运行的`QThread`中。

#### 2.1.3. `AnalysisCalculator` (核心算法)
-   **职责**: 包含实际的数据分析算法（计算直方图、波形图等的纯Python函数）。
-   **修改点**: 无需大的修改。`AnalysisWorker`将调用此类中的方法来执行计算。此类应保持无状态，不依赖任何UI组件。

#### 2.1.4. PyQtGraph Widgets (视图)
-   **职责**: 仅负责展示数据。
-   **修改点**:
    -   移除所有内部触发数据计算的逻辑。
    -   提供一个公共的槽函数 `update_data(data)`，用于接收`AnalysisWorker`计算出的结果并更新图表。

### 2.2. 数据与控制流

1.  **用户操作**: 用户在`AnalysisPanel`上点击一个按钮，请求切换到“直方图”视图。
2.  **UI响应**:
    -   `AnalysisPanel`立即调用`QStackedWidget.setCurrentWidget()`，切换到已存在的`PyQtGraphHistogramWidget`实例。UI切换瞬间完成。
    -   同时，`AnalysisPanel`发出一个信号 `analysis_requested("histogram", current_image_data)`。
3.  **后台计算**:
    -   该信号连接到`AnalysisWorker`的`do_analysis`槽。
    -   `AnalysisWorker`在其所在的后台线程中，调用`AnalysisCalculator.calculate_histogram(current_image_data)`。此时UI主线程完全自由，可以响应其他操作。
4.  **结果返回**:
    -   计算完成后，`AnalysisWorker`发出信号 `analysis_complete(histogram_data, "histogram")`。
5.  **UI更新**:
    -   该信号连接到`PyQtGraphHistogramWidget`的`update_data`槽。
    -   `update_data`槽函数在UI主线程中被调用，使用`histogram_data`安全地更新图表内容。

### 2.3. 状态管理

-   UI状态（当前显示的图表类型）由`AnalysisPanel`中的`QStackedWidget`的当前索引或当前控件来维护。
-   数据状态（当前图像、分析结果等）可以由一个更高层次的管理器（如`StateManager`或`AppContext`）来维护，确保数据的一致性。

通过此设计，即使用户快速连续点击切换多个图表，UI也能保持流畅响应。每个点击只会触发一次视图切换和一次计算请求，后台的计算任务可能会排队执行，但不会阻塞UI。
