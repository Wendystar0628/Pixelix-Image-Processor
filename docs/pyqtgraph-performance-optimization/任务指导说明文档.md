# 任务指导说明文档：PyQtGraph性能优化实施步骤

本文档旨在为开发者提供一个清晰、可执行的任务清单，以完成PyQtGraph性能优化工作。

## 准备工作

1.  **代码备份**: 在开始重构之前，请使用Git创建一个新的分支，以确保主分支的稳定性。
    ```bash
    git checkout -b feature/pyqtgraph-performance-optimization
    ```
2.  **环境确认**: 确保开发环境中的PyQt6和PyQtGraph库已正确安装。

## 任务分解

### 阶段一：创建后台计算模块

#### 任务 1.1: 创建 `AnalysisWorker` 类
-   **文件**: 在 `app/workers/` 目录下创建一个新文件 `analysis_worker.py`。
-   **内容**:
    -   定义一个名为 `AnalysisWorker` 的类，继承自 `QObject`。
    -   定义一个信号 `analysis_complete = Signal(str, object)`，用于发送计算结果。第一个参数是分析类型（如 "histogram"），第二个参数是结果数据。
    -   定义一个槽 `do_analysis(self, analysis_type: str, image: np.ndarray)`。
    -   在 `do_analysis` 方法中，根据 `analysis_type` 调用 `app.core.analysis_calculator` 中对应的静态计算方法。
    -   计算完成后，通过 `analysis_complete` 信号将结果发射出去。

#### 任务 1.2: 在主应用中集成 `AnalysisWorker`
-   **文件**: 修改 `app/main.py` 或应用主控制器。
-   **内容**:
    -   在应用初始化时，创建一个 `QThread` 实例和一个 `AnalysisWorker` 实例。
    -   调用 `worker.moveToThread(thread)` 将worker移动到后台线程。
    -   启动线程 `thread.start()`。
    -   确保在应用退出时，调用 `thread.quit()` 和 `thread.wait()` 来优雅地停止线程。

### 阶段二：重构UI控件

#### 任务 2.1: 修改PyQtGraph图表控件
-   **涉及文件**:
    -   `app/ui/widgets/pyqtgraph_histogram_widget.py`
    -   `app/ui/widgets/pyqtgraph_rgb_parade_widget.py`
    -   `app/ui/widgets/pyqtgraph_luma_waveform_widget.py`
    -   以及其他所有相关的 `pyqtgraph_*_widget.py` 文件。
-   **修改内容**:
    -   移除所有控件内部触发数据计算的逻辑（例如，不要在 `update_image` 或类似方法中直接调用 `AnalysisCalculator`）。
    -   为每个控件添加一个公共槽函数 `update_data(self, data)`。
    -   `update_data` 的实现应仅包含使用传入的 `data` 更新PyQtGraph图表项（`PlotItem`）的逻辑。

#### 任务 2.2: 重构 `AnalysisPanel`
-   **文件**: `app/ui/panels/analysis_panel.py`
-   **修改内容**:
    -   在 `__init__` 方法中：
        -   创建一个 `QStackedWidget` 作为核心布局。
        -   一次性实例化所有需要的PyQtGraph图表控件（`PyQtGraphHistogramWidget`等）。
        -   将这些实例化的控件逐一添加到 `QStackedWidget` 中。
    -   创建一个字典，用于将分析类型名称（如 "histogram"）映射到其在 `QStackedWidget` 中的对应控件实例。
    -   修改处理按钮点击的槽函数（例如 `on_histogram_button_clicked`）：
        -   该函数现在只做两件事：
            1.  使用 `QStackedWidget.setCurrentWidget()` 切换到对应的图表控件。
            2.  发出一个信号，请求进行后台计算。

### 阶段三：连接信号与槽

#### 任务 3.1: 建立完整的信号链
-   **文件**: `app/controllers/app_controller.py` 或 `app/ui/main_window.py` (取决于当前架构)。
-   **内容**:
    -   **请求信号**: 将 `AnalysisPanel` 中请求计算的信号连接到 `AnalysisWorker` 的 `do_analysis` 槽。
    -   **结果信号**: 将 `AnalysisWorker` 的 `analysis_complete` 信号连接到 `AnalysisPanel` 或直接连接到各个图表控件的 `update_data` 槽。建议在 `AnalysisPanel` 中创建一个分发槽，根据返回的分析类型，调用相应图表控件的 `update_data` 方法。

## 阶段四：测试与验证

1.  **功能测试**:
    -   运行应用，加载一张图片。
    -   在分析面板中反复点击切换不同的图表。
    -   **预期结果**: UI界面切换流畅，无任何卡顿。图表数据在短暂延迟后正确显示。
2.  **性能测试**:
    -   （可选）使用性能分析工具（如 `cProfile`）来量化优化前后的性能差异。
3.  **回归测试**:
    -   确认应用的其他功能（如图像处理、文件保存/加载）未受影响。

完成以上所有步骤后，本次性能优化任务即告完成。
