# 核心层分层架构违规修复实施计划

## 实施任务

### 第一阶段：接口定义和基础设施

- [ ] 1. 创建UI交互抽象接口
  - 定义InteractiveWidgetInterface抽象接口
  - 添加鼠标操作、显示更新等核心方法
  - 确保接口足够抽象但功能完整
  - _需求: 1.1, 4.1_

- [ ] 2. 创建对话框管理抽象接口
  - 定义DialogManagerInterface抽象接口
  - 添加对话框创建、关闭、状态查询方法
  - 设计灵活的对话框类型参数系统
  - _需求: 3.1, 3.2_

- [ ] 3. 创建UI服务工厂抽象接口
  - 定义UIServiceFactoryInterface抽象接口
  - 添加UI组件创建和配置方法
  - 设计可扩展的服务创建机制
  - _需求: 3.1, 3.3_

- [ ] 4. 更新核心接口导出
  - 在app/core/interfaces/__init__.py中导出新接口
  - 确保接口命名符合现有规范
  - 验证接口导入无循环依赖
  - _需求: 1.2, 2.1_

### 第二阶段：核心接口实现

- [ ] 5. 创建核心接口实现目录结构
  - 创建app/ui/implementations/目录
  - 创建实现层模块的__init__.py
  - 建立接口实现导出规范
  - _需求: 1.3, 5.1_

- [ ] 6. 实现交互组件接口
  - 创建WidgetImplementation类
  - 实现InteractiveWidgetInterface的所有方法
  - 适配InteractiveImageLabel的具体功能
  - 添加错误处理和异常包装
  - _需求: 4.2, 4.3_

- [ ] 7. 实现对话框管理接口
  - 创建DialogImplementation类
  - 实现DialogManagerInterface的所有方法
  - 适配现有DialogManager的功能
  - 确保对话框操作的完整性
  - _需求: 3.2, 3.3_

- [ ] 8. 实现UI服务工厂接口
  - 创建UIFactoryImplementation类
  - 实现UIServiceFactoryInterface的所有方法
  - 整合现有UI服务创建逻辑
  - 确保服务创建的正确性
  - _需求: 3.1, 3.2, 3.3_

### 第三阶段：依赖注入配置

- [ ] 9. 更新ServiceBuilder配置
  - 在ServiceBuilder中添加UI接口绑定方法
  - 注册UI抽象接口到实现类的映射
  - 确保绑定的正确性和完整性
  - _需求: 5.1, 5.2_

- [ ] 10. 更新ApplicationBootstrap配置
  - 创建UI接口实现实例
  - 注册UI实现类到依赖注入容器
  - 配置UI服务的启动顺序
  - _需求: 5.1, 5.3_

- [ ] 11. 验证依赖注入解析
  - 测试UI接口的正确解析
  - 验证实现类实例的创建
  - 确保依赖链的完整性
  - _需求: 5.2, 5.3_

### 第四阶段：核心层代码迁移

- [ ] 12. 迁移BaseTool的UI依赖
  - 更新BaseTool构造函数接受UI抽象接口
  - 移除对InteractiveImageLabel的直接导入
  - 将UI操作改为通过接口调用
  - 测试工具功能的正确性
  - _需求: 2.1, 4.1, 4.2_

- [ ] 13. 迁移UIServiceFactory的UI依赖
  - 更新UIServiceFactory使用接口工厂模式
  - 移除对具体DialogManager的直接导入
  - 通过接口实现创建UI服务
  - 验证UI服务创建的正确性
  - _需求: 2.1, 3.1, 3.2_

- [ ] 14. 更新工具管理器的UI集成
  - 修改ToolManager以使用UI抽象接口
  - 确保工具与UI的正确交互
  - 验证工具切换和操作功能
  - _需求: 4.1, 4.3_

### 第五阶段：清理和验证

- [ ] 15. 清理直接UI导入
  - 搜索并移除app/core/中所有`from app.ui import`语句
  - 移除对具体UI组件的直接引用
  - 清理相关的过时注释
  - _需求: 2.1, 2.2_

- [ ] 16. 验证分层架构合规性
  - 使用静态分析工具检查分层违规
  - 确认核心层不再直接依赖UI层
  - 验证依赖方向的正确性
  - _需求: 1.1, 2.3_

- [ ] 17. 功能完整性测试
  - 测试所有UI交互功能的正常工作
  - 验证用户操作流程的完整性
  - 确认性能无显著影响
  - _需求: 1.2, 4.3_

- [ ] 18. 编写Mock测试示例
  - 为UI抽象接口创建Mock实现
  - 编写核心层组件的单元测试
  - 验证测试隔离的有效性
  - _需求: 1.3, 4.3_

## 风险控制

### 高风险任务
- 任务12, 13: 核心层代码迁移，可能影响核心功能
- 任务15: 清理直接导入，可能破坏现有功能

### 中风险任务  
- 任务6, 7, 8: 适配器实现，需要确保功能完整性
- 任务9, 10: 依赖注入配置，可能影响启动流程

### 低风险任务
- 任务1, 2, 3: 接口定义，纯抽象不影响现有功能
- 任务16, 17: 验证测试，不修改功能代码

## 验证标准

### 架构合规性验证
- [ ] 核心层无直接UI导入：`grep -r "from app.ui" app/core/` 无结果
- [ ] 核心层无UI组件引用：静态分析工具无分层违规警告
- [ ] 依赖方向正确：所有依赖都是从上层到下层

### 功能完整性验证
- [ ] 所有UI交互功能正常工作
- [ ] 工具操作与用户交互无异常
- [ ] 对话框管理功能完全保持
- [ ] 系统启动和运行稳定

### 可测试性验证
- [ ] 可以为核心层组件创建独立的单元测试
- [ ] UI接口可以使用Mock实现替换
- [ ] 测试运行不依赖真实UI环境