# 核心层分层架构违规修复需求文档

## 项目概述

当前系统存在严重的分层架构违规问题：核心层（Core Layer）直接导入和依赖UI层组件，违反了分层架构的基本原则。这种违规不仅破坏了架构的清晰性，还引入了潜在的循环导入风险，可能导致系统在某些场景下出现导入错误。本项目旨在通过接口抽象和依赖注入，彻底消除核心层对UI层的直接依赖，建立清晰的分层边界。

## 需求分析

### 需求1：核心层UI依赖抽象化

**用户故事：** 作为系统架构师，我希望核心层不直接依赖UI组件，而是通过接口抽象与UI层交互，以便维护清晰的分层架构边界。

#### 验收标准
1. 当核心层需要UI功能时，系统应该通过抽象接口访问而非直接导入UI组件
2. 当UI层实现发生变化时，系统应该不影响核心层代码的稳定性
3. 当系统启动时，系统应该能够正确解析核心层对UI抽象的依赖关系

### 需求2：消除直接UI组件导入

**用户故事：** 作为开发者，我希望移除核心层对UI组件的直接导入，避免违反分层架构原则和潜在的循环依赖风险。

#### 验收标准
1. 当检查核心层代码时，系统应该不包含`from app.ui import`相关的导入语句
2. 当核心层需要UI交互时，系统应该通过依赖注入获取UI抽象接口
3. 当运行静态分析时，系统应该不出现分层违规警告

### 需求3：UI服务工厂抽象重构

**用户故事：** 作为系统设计者，我希望UI服务工厂使用接口抽象而非直接依赖具体UI组件，提高系统的可测试性和可维护性。

#### 验收标准
1. 当UIServiceFactory创建UI服务时，系统应该通过接口工厂模式而非直接实例化
2. 当UI组件需要注入到核心层时，系统应该通过接口抽象进行传递
3. 当测试UI服务工厂时，系统应该能够轻松使用Mock实现替换真实UI组件

### 需求4：工具层UI交互抽象

**用户故事：** 作为工具开发者，我希望基础工具类通过抽象接口与UI组件交互，而不是直接依赖具体的UI实现。

#### 验收标准
1. 当BaseTool需要UI交互时，系统应该通过抽象的交互接口而非直接依赖InteractiveImageLabel
2. 当新的UI组件需要与工具交互时，系统应该通过实现交互接口来实现兼容
3. 当工具执行UI操作时，系统应该通过依赖注入获取UI交互能力

### 需求5：依赖注入容器增强

**用户故事：** 作为系统集成者，我希望依赖注入容器能够支持UI抽象接口的注册和解析，确保核心层能够正确获取UI功能。

#### 验收标准
1. 当注册UI抽象接口时，系统应该支持接口到实现的绑定
2. 当核心层请求UI抽象时，系统应该正确解析并返回相应的实现
3. 当系统启动时，系统应该验证所有UI抽象接口绑定的完整性

## 技术约束

1. UI抽象接口必须放置在app/core/interfaces/目录下
2. UI接口实现必须保持在UI层，通过适配器模式与核心层接口对接
3. 必须保持现有UI功能完全不变，仅改变依赖方式
4. 必须通过依赖注入容器管理所有UI抽象的生命周期
5. 核心层不得直接导入任何UI层的具体实现

## 非功能性需求

1. **性能**：UI抽象层不应显著影响UI操作性能
2. **兼容性**：必须与现有UI组件和交互逻辑完全兼容
3. **可测试性**：UI抽象接口应该便于创建Mock实现进行单元测试
4. **可维护性**：接口定义应该简洁明确，避免过度抽象
5. **架构一致性**：必须严格遵循分层架构原则，禁止跨层直接依赖