# 依赖注入重构需求文档

## 概述

本文档描述了将当前软件从全局访问器模式重构为依赖注入模式的需求。重构的目标是移除全局状态污染，实现真正的控制反转，提升代码的可测试性和可维护性。

## 当前问题

### 1. 全局访问器污染
- `get_config_manager()` - 全局配置管理器访问
- `get_app_context()` - 全局应用上下文访问  
- `get_state_manager()` - 全局状态管理器访问
- `get_processing_handler()` - 全局处理器访问

### 2. 隐式依赖关系
- 组件通过全局函数获取依赖，依赖关系不透明
- 难以进行单元测试和依赖模拟
- 循环依赖风险高

### 3. 服务获取方式混乱
- 部分组件通过ServiceRegistry获取服务
- 部分组件通过全局函数获取服务
- 缺乏统一的依赖管理策略

## 重构目标

### 1. 移除全局访问器 🎯
- **彻底移除**所有`get_*`全局函数
- **清理**所有全局变量和单例模式
- **替换**为显式的依赖注入

### 2. 构造函数注入 🎯
- **核心服务**改为构造函数注入
- **UI组件**通过构造函数接收依赖
- **控制器**通过构造函数接收服务依赖

### 3. 接口定义 🎯
- **定义**主要服务的抽象接口
- **实现**接口契约验证
- **建立**清晰的服务边界

## 功能需求

### 1. 核心接口定义
- 图像处理服务接口 `ImageProcessorInterface`
- 状态管理服务接口 `StateManagerInterface`  
- 配置管理服务接口 `ConfigManagerInterface`
- 应用控制服务接口 `AppControllerInterface`

### 2. 依赖注入容器
- 替换当前的ServiceRegistry为专门的DI容器
- 支持构造函数注入和接口绑定
- 提供依赖关系验证和循环依赖检测

### 3. 服务工厂重构
- 简化ServiceFactory职责
- 移除服务定位逻辑
- 专注于依赖关系配置

### 4. 主窗口重构
- MainWindow通过构造函数接收所有依赖
- 移除`_get_service`方法和context访问
- 建立明确的依赖声明

## 非功能需求

### 1. 向后兼容性
- 重构过程中保持功能完整性
- API行为保持不变
- 不影响现有业务逻辑

### 2. 代码简洁性
- 最小化代码改动量
- 避免过度设计
- 保持当前架构的简单性

### 3. 可测试性
- 支持依赖模拟和替换
- 便于单元测试编写
- 隔离测试环境

## 约束条件

### 1. 技术约束
- 保持PyQt6框架使用
- 维持现有的信号-槽机制
- 不改变核心业务逻辑

### 2. 实施约束  
- 采用渐进式重构策略
- 确保每个阶段都可运行
- 最小化开发风险

### 3. 维护约束
- 代码命名易于AI理解
- 避免相同文件名
- 保持简单的文件结构

## 验收标准

### 1. 全局访问器移除 ✓
- [ ] 所有`get_*`函数被移除
- [ ] 所有全局变量被清理
- [ ] 无任何单例模式残留

### 2. 依赖注入实现 ✓
- [ ] 核心服务通过构造函数注入
- [ ] UI组件依赖显式声明
- [ ] 服务间依赖关系透明

### 3. 接口契约建立 ✓
- [ ] 主要服务定义了抽象接口
- [ ] 依赖关系通过接口约束
- [ ] 服务边界清晰明确

### 4. 功能完整性 ✓
- [ ] 所有现有功能正常工作
- [ ] 性能无明显下降
- [ ] 错误处理保持不变

## 风险控制

### 1. 技术风险
- **循环依赖** - 通过接口抽象和分层设计避免
- **性能影响** - 依赖注入带来的微小开销可接受
- **复杂度增加** - 通过简单设计控制复杂度

### 2. 实施风险
- **功能破坏** - 分阶段重构并保持测试覆盖
- **开发延期** - 采用最小可行方案
- **理解困难** - 提供清晰的文档和命名

## 总结

本次重构将彻底解决全局状态污染问题，建立清晰的依赖关系，为软件的长期维护和扩展奠定基础。重构将采用简单务实的方案，确保在提升代码质量的同时保持系统的稳定性。