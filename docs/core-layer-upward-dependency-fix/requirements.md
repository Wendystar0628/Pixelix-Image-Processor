# 核心层向上依赖违反分层架构修复需求文档

## 介绍

当前应用存在严重的核心层向上依赖问题：app/core/dependency_injection/service_builder.py和app/core/initialization/direct_service_initializer.py直接导入handlers层和features层的具体实现类，严重违反了四层分层架构的依赖方向原则。这种违反不仅破坏了架构的清晰性，还引入了潜在的循环导入风险，可能导致系统在某些场景下出现导入错误。此问题使得核心层与上层产生紧耦合，违背了依赖倒置原则，严重影响了系统的可维护性和可扩展性。需要通过依赖注入重构和接口抽象化彻底消除核心层对上层的直接依赖。

## 需求

### 需求 1: 彻底消除核心层向上依赖

**用户故事:** 作为架构师，我希望核心层不直接导入handlers层和features层，这样就不会违反分层架构原则

#### 验收标准

1. WHEN 核心层需要上层服务时 THEN 系统 SHALL 通过服务工厂接口而非直接导入具体实现类
2. WHEN 检查核心层代码时 THEN 系统 SHALL 不包含任何`from app.handlers import`或`from app.features import`的导入语句
3. WHEN 应用启动时 THEN 系统 SHALL 无任何分层架构违反导致的循环导入错误

### 需求 2: 建立桥接适配器模式

**用户故事:** 作为开发者，我希望建立简单的桥接适配器管理上层服务访问，这样核心层与上层服务完全解耦

#### 验收标准

1. WHEN 系统需要访问上层服务时 THEN 服务访问 SHALL 通过桥接适配器接口进行
2. WHEN 上层服务实例创建时 THEN 它 SHALL 在初始化层创建并通过适配器注册
3. WHEN 核心层需要服务实例时 THEN 系统 SHALL 通过桥接适配器获取服务实例

### 需求 3: 重构依赖注入流程

**用户故事:** 作为开发者，我希望依赖注入流程使用桥接适配器模式，这样保持分层架构原则

#### 验收标准

1. WHEN 服务构建器配置服务时 THEN 它 SHALL 通过桥接适配器而非直接导入
2. WHEN 服务初始化器创建服务时 THEN 它 SHALL 创建上层服务并通过适配器注册
3. WHEN 依赖注入完成时 THEN 所有服务创建 SHALL 符合分层架构原则

## 非功能需求

### 架构清晰性要求

1. 依赖关系必须严格单向：Application → Business → Core ← Infrastructure
2. 核心层绝对不能导入handlers层和features层的任何模块
3. 服务创建必须遵循分层原则，避免循环依赖

### 简单性要求

1. 新增代码文件不超过2个
2. 单个文件代码行数控制在80行以内
3. 避免过度抽象和复杂的设计模式
4. 重构方案易于理解和维护

### 向后兼容性要求

1. 现有服务接口和功能保持不变
2. 应用启动流程和用户体验保持稳定
3. 业务功能不受重构影响

### 可维护性要求

1. 新开发者能够快速理解服务工厂模式
2. 服务相关的问题易于定位和调试
3. 架构变更的影响范围可控