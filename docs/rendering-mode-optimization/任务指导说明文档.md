# 任务指导说明文档：渲染模式优化

## 1. 任务目标

实现渲染模式的自动优化功能。软件启动时应检测GPU支持情况，优先使用PyQt (GPU)模式，若不支持则自动降级到Matplotlib (CPU)模式。同时，在UI上明确标注两种模式的区别，并根据硬件支持情况更新UI状态。

**核心原则**: 本次修改应尽可能重用现有代码，以最小的侵入性完成功能。

**参考文档**:
- `需求分析文档.md`
- `技术设计文档.md` (简化版)

---

## 2. 执行步骤与技术细节

### 步骤 1: 实现GPU支持的检测逻辑

**目标**: 创建一个可重用的函数，用于判断当前环境是否能支持 `pyqtgraph` 的OpenGL加速。

- **位置**: 建议在 `app/core/utils/` 目录下创建一个新文件 `system_check.py`，或者将该函数添加到一个已有的通用工具文件中。
- **函数名**: `check_gpu_support()`
- **技术细节**:
    1.  函数应返回一个布尔值 (`True` 表示支持, `False` 表示不支持)。
    2.  使用 `try...except` 块来包裹检测逻辑，以捕获任何潜在的运行时错误（如驱动问题、库缺失等）。
    3.  在 `try` 块中，调用 `pyqtgraph.setConfigOption('useOpenGL', True)` 来尝试启用GPU加速。
    4.  **关键检查点**: 调用后，再通过 `pyqtgraph.getConfigOption('useOpenGL')` 来确认该选项是否真的被成功设置为 `True`。这是最可靠的判断方式。
    5.  如果成功，函数返回 `True`。在返回前，最好将 `useOpenGL` 选项重置为 `False`，以便让后续的配置逻辑来决定最终状态。
    6.  如果 `setConfigOption` 调用失败、检查未通过或发生任何异常，函数应在 `except` 或 `else` 块中返回 `False`。确保在返回前也调用 `setConfigOption('useOpenGL', False)` 以清理状态。
    7.  **日志记录**: 在函数的关键节点（如成功、失败、异常）添加 `logging` 信息，这将极大地帮助未来调试。

### 步骤 2: 在应用启动时集成检测流程

**目标**: 在应用初始化、创建主窗口之前，执行GPU检测并设置全局配置。

- **位置**: 定位到应用的主入口文件，通常是 `app/main.py` 或负责应用生命周期管理的 `app/controllers/app_controller.py`。
- **执行时机**: 必须在 `QApplication` 实例创建之后，但在 `MainWindow` 实例创建之前。
- **技术细节**:
    1.  从 `app.core.utils.system_check` 导入 `check_gpu_support` 函数。
    2.  调用 `check_gpu_support()` 并将其返回的布尔值存储在一个变量中（例如 `is_gpu_supported`）。
    3.  根据 `is_gpu_supported` 的结果，确定默认的渲染模式（`'pyqt'` 或 `'matplotlib'`）。
    4.  将这两个状态信息（`is_gpu_supported` 和 `default_mode`）存入应用的全局配置中（`AppConfig`）。建议使用清晰的键名，如 `rendering.gpu_supported` 和 `rendering.default_mode`。

### 步骤 3: 调整UI以反映系统状态

**目标**: 让用户界面的渲染模式选择器能够动态地展示当前状态。

- **位置**: `app/ui/main_window.py`，或管理相关UI组件的面板类。
- **执行时机**: 在主窗口的 `__init__` 方法中，UI组件初始化之后。
- **技术细节**:
    1.  创建一个新的方法，例如 `update_rendering_options(self)`，并在 `__init__` 的末尾调用它。
    2.  在该方法中，从 `AppConfig` 读取 `rendering.gpu_supported` 和 `rendering.default_mode` 的值。
    3.  **更新标签**: 找到渲染模式选择器（如 `QComboBox`），并使用 `setItemText()` 方法将其选项的显示文本修改为 "PyQt (GPU)" 和 "Matplotlib (CPU)"。
    4.  **禁用选项**: 如果 `is_gpu_supported` 为 `False`，则需要禁用 "PyQt (GPU)" 选项。对于 `QComboBox`，可以通过 `self.render_mode_combobox.model().item(index).setEnabled(False)` 来实现。你需要知道PyQt选项对应的索引。
    5.  **设置默认选项**: 根据从配置中读取的 `default_mode`，使用 `setCurrentIndex()` 或 `setCurrentText()` 来设置选择器的默认显示项。
    6.  **确认信号连接**: 确保选择器的状态改变信号（如 `currentIndexChanged`）仍然连接到现有的处理函数。该处理函数负责在用户手动切换时更新 `AppConfig` 中的 `rendering.default_mode` 值。

---

## 3. 验证要点

- **GPU环境**: 启动后，默认应为 "PyQt (GPU)"，且两个选项均可切换。
- **非GPU环境**: 启动后，默认应为 "Matplotlib (CPU)"，且 "PyQt (GPU)" 选项应为灰色不可选。
- **日志输出**: 检查应用启动时的日志，确认GPU检测结果与预期一致。
