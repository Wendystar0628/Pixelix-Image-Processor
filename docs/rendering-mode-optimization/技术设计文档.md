# 技术设计文档：渲染模式优化（简化版）

## 1. 概述

本文档为“渲染模式优化与自动切换”功能提供了一个**简化且低侵入性**的技术实现方案。鉴于系统已具备渲染模式的手动切换功能，本方案将重用现有架构，仅在必要位置进行最小化修改，以实现启动时自动选择最佳渲染模式并优化UI显示。

## 2. 架构设计

本方案不引入新的管理类，而是在现有应用启动流程和UI代码中直接集成新逻辑。

- **检测逻辑**: 在应用启动时执行一次性的硬件兼容性检查。
- **状态管理**: 利用现有的 `app/config.py` 模块来存储和传递渲染模式的状态。
- **UI更新**: 直接在 `app/ui/main_window.py` 中修改UI组件的标签和行为。

### 2.1. 模块交互流程

```mermaid
graph TD
    A[app/main.py 或 app_controller.py] -- 1. 启动时 --> B(执行 check_gpu_support());
    B -- 检测结果 --> C{GPU是否支持?};
    C -- 是 --> D[更新 AppConfig: mode='pyqt', gpu_supported=True];
    C -- 否 --> E[更新 AppConfig: mode='matplotlib', gpu_supported=False];
    
    F[app/ui/main_window.py] -- 2. 初始化时读取 --> G(AppConfig);
    G -- mode, gpu_supported --> H{更新UI组件};
    H -- 更新标签为 "PyQt (GPU)", "Matplotlib (CPU)" --> I[UI界面];
    H -- 若不支持GPU, 禁用PyQt选项 --> I;

    J[app/utils/plot_renderer.py] -- 3. 渲染时读取 --> G(AppConfig);
    J -- 根据 mode 执行渲染 --> K[数据分析图];
```

## 3. 实现细节

### 3.1. 新增GPU支持检测工具函数

为了保持代码整洁，我们可以在一个合适的工具模块中添加检测函数。`app/core/utils/` 是一个不错的选择。如果该目录下没有合适的工具文件，可以创建一个新的 `system_check.py`。

**文件**: `app/core/utils/system_check.py` (如果创建新文件)

```python
# app/core/utils/system_check.py
import pyqtgraph as pg
import logging

def check_gpu_support() -> bool:
    """
    检测当前环境是否支持PyQtGraph的OpenGL GPU加速。
    通过尝试启用并检查异常来判断。
    
    Returns:
        bool: True表示支持，False表示不支持。
    """
    try:
        # 启用OpenGL，这是检查支持的直接方式
        pg.setConfigOption('useOpenGL', True)
        
        # 检查是否真的开启成功
        if pg.getConfigOption('useOpenGL'):
            logging.info("GPU support check: PyQtGraph OpenGL is available.")
            # 测试后可以恢复默认值，让后续逻辑决定是否开启
            pg.setConfigOption('useOpenGL', False) 
            return True
        else:
            logging.warning("GPU support check: Failed to enable PyQtGraph OpenGL.")
            return False
            
    except Exception as e:
        # 捕获所有可能的异常，例如缺少驱动、库文件等
        logging.error(f"GPU support check failed with an exception: {e}")
        pg.setConfigOption('useOpenGL', False) # 确保在异常时关闭
        return False

```

### 3.2. 修改应用启动逻辑

在应用的入口文件（如 `app/main.py` 或 `app/controllers/app_controller.py`）的早期阶段，调用检测函数并更新配置。

**文件**: `app/main.py` (示例)

```python
# app/main.py (伪代码)

from app.core.utils.system_check import check_gpu_support
from app.config import AppConfig # 假设这是您的配置管理器
from app.ui.main_window import MainWindow
from PyQt6.QtWidgets import QApplication
import logging

# 配置日志
logging.basicConfig(level=logging.INFO)

def main():
    app = QApplication([])

    # 1. 在UI创建前，执行硬件检测并设置配置
    is_gpu_supported = check_gpu_support()
    default_mode = 'pyqt' if is_gpu_supported else 'matplotlib'
    
    AppConfig.set('rendering.gpu_supported', is_gpu_supported)
    AppConfig.set('rendering.default_mode', default_mode)
    logging.info(f"GPU Supported: {is_gpu_supported}. Default render mode set to: '{default_mode}'")

    # 2. 正常启动主窗口
    main_win = MainWindow()
    main_win.show()

    app.exec()

if __name__ == '__main__':
    main()
```

### 3.3. 修改UI界面

在主窗口的UI初始化代码中，根据配置来更新渲染模式选项。

**文件**: `app/ui/main_window.py` (示例)

```python
# app/ui/main_window.py (伪代码)

from app.config import AppConfig

class MainWindow:
    def __init__(self):
        # ...
        self.setup_ui()
        self.update_rendering_options()

    def update_rendering_options(self):
        # 假设有一个下拉菜单 self.render_mode_combobox
        # 它的选项可能是在Qt Designer中设置的，或者在代码中添加
        # 我们在这里只修改标签和状态

        is_gpu_supported = AppConfig.get('rendering.gpu_supported', False)
        default_mode = AppConfig.get('rendering.default_mode', 'matplotlib')

        # 假设Combobox有两项，0是PyQt, 1是Matplotlib
        # 修改标签
        self.render_mode_combobox.setItemText(0, "PyQt (GPU)")
        self.render_mode_combobox.setItemText(1, "Matplotlib (CPU)")

        # 如果不支持GPU，禁用PyQt选项
        if not is_gpu_supported:
            # 找到PyQt选项并禁用它
            # 注意：这里的实现取决于你是如何添加item的
            # 如果是通过text查找
            pyqt_item_index = self.render_mode_combobox.findText("PyQt (GPU)")
            if pyqt_item_index != -1:
                 self.render_mode_combobox.model().item(pyqt_item_index).setEnabled(False)

        # 根据配置设置默认显示的选项
        if default_mode == 'pyqt':
            self.render_mode_combobox.setCurrentIndex(0)
        else:
            self.render_mode_combobox.setCurrentIndex(1)
        
        # 现有的切换逻辑（如 on_render_mode_changed）应该可以继续工作
        # 它只需要确保在切换时，将新模式写入AppConfig即可
```

### 3.4. 渲染模块
`app/utils/plot_renderer.py` **很可能不需要任何修改**，因为它应该已经从 `AppConfig` 读取当前的渲染模式来决定使用哪个后端。由于我们在启动时已经正确设置了该配置，它的行为将自动符合新逻辑。

## 4. 测试计划

- **集成测试**:
    - 验证应用启动后，在支持GPU的设备上，默认选项为“PyQt (GPU)”。
    - 验证在不支持GPU的环境（如虚拟机）中，默认选项为“Matplotlib (CPU)”，且“PyQt (GPU)”选项被禁用。
- **手动测试**:
    - 确认UI标签已正确更新。
    - 在支持GPU的设备上，测试从“PyQt (GPU)”切换到“Matplotlib (CPU)”的功能是否正常。
