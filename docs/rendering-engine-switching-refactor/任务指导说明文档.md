# 渲染引擎切换重构实施计划

- [ ] 1. **重构 `AnalysisPanel` 初始化逻辑**
  - 在 `app/ui/panels/analysis_panel.py` 文件中找到 `_init_widgets` 方法。
  - **删除**该方法内所有创建 `matplotlib_widgets` 和 `pyqtgraph_widgets` 的代码。
  - **删除** `__init__` 方法中对 `self.matplotlib_widgets` 和 `self.pyqtgraph_widgets` 的初始化。
  - 在 `__init__` 方法中，将 `self.analysis_manager` 初始化为 `None`。
  - _需求: 1.1_

- [ ] 2. **实现资源清理方法**
  - 在 `AnalysisPanel` 类中，创建一个新的私有方法 `_cleanup_current_engine(self)`。
  - 在此方法中，添加逻辑：
    - 检查 `self.analysis_manager` 是否不为 `None`。如果是，则调用 `self.analysis_manager.deleteLater()`。
    - 清空 `self.analysis_tabs` 中的所有标签页。使用一个循环，例如 `while self.analysis_tabs.count() > 0: self.analysis_tabs.removeTab(0)`。**注意：** 在调用 `removeTab` 后，还需要确保从标签页中取出的 widget 被正确销毁。一个更稳妥的方法是，在销毁 `analysis_manager` 的同时，也销毁它所持有的所有 widgets。
  - _需求: 1.1, 1.4_

- [ ] 3. **改造核心切换逻辑**
  - 在 `AnalysisPanel` 中找到 `_switch_to_engine(self, engine_name)` 方法。
  - 在该方法的最开始，调用 `self._cleanup_current_engine()`，确保在创建新组件前，旧的已被清理。
  - **移除**从 `self.matplotlib_widgets` 或 `self.pyqtgraph_widgets` 获取组件的旧逻辑。
  - **添加**新的逻辑：根据传入的 `engine_name`，**即时创建**所需的UI组件实例（`ImageInfoWidget`, `PyQtGraphCombinedAnalysisWidget` 等）。
  - 使用新创建的组件实例来创建 `AnalysisComponentsManager`。
  - 将新创建的组件添加到 `self.analysis_tabs` 中。
  - _需求: 1.1, 1.4_

- [ ] 4. **调整 `_apply_engine_change` 方法**
  - 确保 `_apply_engine_change` 方法在调用 `_switch_to_engine` 后，能正确触发一次分析更新，以加载新引擎的图表。
  - _需求: 1.3_

- [ ] 5. **验证和测试**
  - 启动应用程序。
  - 多次在 "matplotlib" 和 "pyqtgraph" 渲染引擎之间来回切换。
  - **观察**:
    - 切换过程是否顺畅。
    - 切换后，图表是否能正常显示和更新。
    - 使用系统任务管理器或专门的内存分析工具，确认程序的内存占用在多次切换后保持稳定，没有出现持续增长。
  - _需求: 1.2, 1.3_
