# 批处理与资源管理重构实施计划

## 实施任务列表

- [x] 1. 创建新的目录结构和基础文件


  - 创建app/features/目录和app/features/batch_processing/目录结构
  - 创建app/core/下的新子目录结构(processing, resources, tasks, monitoring)
  - 为所有新目录创建__init__.py文件
  - _需求: 1.1, 2.1, 3.1_



- [x] 2. 重构核心服务层接口定义


  - 在app/core/processing/interfaces.py中定义ProcessorExtension抽象基类
  - 在app/core/resources/interfaces.py中定义ResourceProvider抽象基类  

  - 在app/core/tasks/interfaces.py中定义TaskHandler抽象基类
  - _需求: 2.5_

- [x] 3. 迁移和重构图像处理核心组件

  - 将app/core/integration/extensible_processor.py迁移到app/core/processing/image_processor.py
  - 将app/core/integration/extensions/processor_extensions.py迁移到app/core/processing/extensions.py
  - 更新image_processor.py中的导入语句使用相对导入
  - 更新extensions.py中的接口导入路径
  - _需求: 2.1_


- [x] 4. 迁移和重构资源管理组件

  - 将app/core/integration/resource_manager.py迁移到app/core/resources/manager.py
  - 将app/core/integration/extensions/resource_providers.py迁移到app/core/resources/providers.py
  - 更新manager.py中的导入语句和接口引用
  - 更新providers.py中的接口实现
  - _需求: 2.2_




- [x] 5. 迁移和重构任务协调组件

  - 将app/core/integration/task_coordinator.py迁移到app/core/tasks/coordinator.py
  - 将app/core/integration/extensions/task_handlers.py迁移到app/core/tasks/handlers.py
  - 更新coordinator.py中的导入语句和接口引用
  - 更新handlers.py中的接口实现


  - _需求: 2.3_

- [x] 6. 迁移性能监控组件


  - 将app/core/integration/performance_monitor.py迁移到app/core/monitoring/performance_monitor.py
  - 更新performance_monitor.py中的导入语句
  - _需求: 2.4_

- [x] 7. 创建批处理功能模块的数据模型


  - 将app/core/models/batch_models.py迁移到app/features/batch_processing/models.py
  - 更新models.py中的导入语句和类型注解
  - 确保所有批处理相关的数据类都在此文件中定义
  - 添加分析导出相关的数据模型（AnalysisExportConfig、AnalysisType等）
  - _需求: 3.4, 3.5_


- [x] 8. 迁移批处理核心处理器和工作线程


  - 将app/handlers/batch_processing/batch_processing_handler.py迁移到app/features/batch_processing/handler.py
  - 将app/workers/batch_processing_worker.py迁移到app/features/batch_processing/worker.py
  - 更新handler.py中的导入语句，使用相对导入引用内部管理器
  - 更新worker.py中对核心服务的导入路径
  - _需求: 3.1_

- [x] 9. 创建批处理管理器子模块

  - 创建app/features/batch_processing/managers/目录和__init__.py
  - 将app/core/managers/batch_job_manager.py迁移到app/features/batch_processing/managers/job_manager.py
  - 将app/core/managers/job_execution_manager.py迁移到app/features/batch_processing/managers/execution_manager.py
  - 将app/core/managers/image_pool_manager.py迁移到app/features/batch_processing/managers/pool_manager.py
  - 将app/handlers/batch_processing/progress_manager.py迁移到app/features/batch_processing/managers/progress_manager.py
  - _需求: 3.2_

- [x] 10. 更新批处理管理器内部导入关系

  - 更新job_manager.py中的导入语句，引用同级models.py
  - 更新execution_manager.py中的导入语句和依赖关系
  - 更新pool_manager.py中对核心服务的导入路径
  - 更新progress_manager.py中的导入语句
  - _需求: 3.2_

- [x] 11. 迁移批处理UI组件


  - 创建app/features/batch_processing/ui/目录和__init__.py
  - 将app/ui/dialogs/batch_progress_dialog.py迁移到app/features/batch_processing/ui/progress_dialog.py
  - 将app/ui/panels/batch_processing_panel/整个目录迁移到app/features/batch_processing/ui/
  - 检查是否存在分析导出相关的UI对话框，如果有则一并迁移
  - 更新所有UI组件中的导入语句，引用新的模型和处理器路径
  - _需求: 3.3_

- [x] 12. 修复应用上下文和依赖注入


  - 更新app/context.py中的所有导入语句，指向新的模块路径
  - 修复AppContext类中的对象实例化顺序和依赖关系
  - 确保所有核心服务和功能模块都能正确实例化
  - 添加导入错误的异常处理和诊断信息
  - _需求: 4.2_

- [x] 13. 修复控制器层的导入关系


  - 更新app/controllers/batch_processing_controller.py中的导入语句
  - 将BatchProcessingHandler的导入路径更新为app.features.batch_processing.handler
  - 验证控制器与新功能模块的连接正常
  - _需求: 4.1_

- [x] 14. 修复Qt信号槽定义和连接


  - 检查所有UI组件中的pyqtSignal定义，更新自定义类型的导入路径
  - 修复信号槽连接中涉及的类型引用
  - 验证信号发射和接收的正确性
  - 重新编译.ui文件(如果存在)
  - _需求: 4.3_

- [ ] 15. 实现数据序列化兼容性处理
  - 创建数据迁移脚本处理旧的pickle文件
  - 实现向后兼容的反序列化逻辑
  - 添加数据格式版本检测和自动升级机制
  - 提供用户数据迁移工具
  - _需求: 4.4, 6.1, 6.2_

- [x] 16. 实施循环导入检测和修复








  - 使用静态分析工具检测潜在的循环导入
  - 应用依赖倒置原则修复发现的循环依赖
  - 实现接口定义和依赖注入来打破循环
  - 验证所有模块都能正常导入
  - _需求: 4.5_

- [x] 17. 创建重构验证测试套件


  - 编写导入路径验证测试用例
  - 创建依赖注入正确性测试
  - 实现信号槽连接测试
  - 添加数据序列化兼容性测试
  - 创建端到端功能测试
  - _需求: 7.2, 7.3_

- [ ] 18. 运行完整测试和功能验证
  - 执行所有单元测试确保通过
  - 运行集成测试验证模块协作
  - 进行手动功能测试验证关键业务流程
  - 测试应用启动和关闭流程
  - 验证批处理功能的完整工作流程
  - _需求: 7.1, 7.2_

- [ ] 19. 性能测试和优化
  - 测量重构后的应用启动时间
  - 监控内存使用情况和潜在泄漏
  - 验证批处理性能没有退化
  - 优化导入性能和资源使用
  - _需求: 7.1_


- [x] 20. 创建分析导出功能适配器


  - 创建app/features/batch_processing/analysis/目录结构
  - 创建app/features/batch_processing/analysis/services/analysis_export_adapter.py
  - 实现适配器连接核心分析导出服务和批处理功能
  - 将app/workers/analysis_export_worker.py迁移到app/features/batch_processing/analysis/worker.py
  - 更新分析导出工作线程的导入路径
  - _需求: 3.5, 4.5, 4.6_

- [ ] 21. 清理过时代码和文件
  - 删除app/core/batch_processor.py
  - 删除app/workers/batch_processor_worker.py
  - 评估app/workers/analysis_export_worker.py是否需要保留（如果已迁移则删除）
  - 删除空的app/core/integration/目录及其子目录
  - 清理所有不再使用的旧文件和空目录
  - 更新.gitignore文件排除临时文件
  - _需求: 5.1, 5.2, 5.3_

- [ ] 22. 验证分析导出功能集成
  - 测试批处理作业的分析导出功能
  - 验证分析导出适配器的正确性
  - 测试各种分析类型的导出（RGB直方图、RGB parade、亮度波形等）
  - 确保分析导出不会影响批处理的主要功能
  - _需求: 3.5, 7.2_

- [ ] 23. 创建重构文档和迁移指南
  - 编写重构完成报告文档
  - 创建新架构的开发者指南
  - 提供故障排除和常见问题解答
  - 更新项目README反映新的代码结构
  - 创建向后兼容性说明文档
  - 包含分析导出功能的迁移说明
  - _需求: 6.3_

- [ ] 24. 实施监控和日志记录
  - 添加重构过程的进度监控
  - 实现运行时导入性能监控
  - 创建错误率监控和报告机制
  - 添加依赖关系跟踪日志
  - 监控分析导出功能的性能和稳定性
  - _需求: 4.1_