# 事件总线集成实现计划

## 实现任务

- [ ] 1. 创建事件总线接口和实现
  - 创建EventBusInterface接口定义
  - 实现EventBusImpl类，提供订阅、发布、取消订阅功能
  - 确保线程安全和异常隔离
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [ ] 2. 定义事件类型注册表和载荷模型
  - 创建EventTypeRegistry类定义事件类型常量
  - 创建EventPayloadModels定义事件数据结构
  - _需求: 3.1, 3.2, 3.3, 3.4_

- [ ] 3. 集成事件总线到分层初始化器
  - 在LayeredServiceInitializer的第1层初始化事件总线
  - 注册事件总线到依赖容器
  - _需求: 2.1, 2.2_

- [ ] 4. 扩展服务定位器支持事件总线
  - 在ServiceLocator中添加获取事件总线的方法
  - 保持与现有服务获取模式一致
  - _需求: 2.2_

- [ ] 5. 重构状态管理器使用事件通信
  - 修改StateManager在状态变更时发布事件
  - 移除部分直接的服务调用依赖
  - _需求: 4.1_

- [ ] 6. 重构图像处理流程使用事件通信
  - 修改图像加载完成时发布事件
  - 修改图像处理完成时发布事件
  - _需求: 4.2_

- [ ] 7. 重构批处理进度通知使用事件通信
  - 修改批处理任务状态变更时发布事件
  - 替换直接的进度更新调用
  - _需求: 4.3_

- [ ] 8. 添加应用关闭时的事件总线清理
  - 在ApplicationBootstrap的cleanup_services中清理事件总线
  - 确保所有订阅关系被正确清理
  - _需求: 2.3_

- [ ] 9. 编写事件总线实现功能测试
  - 测试事件订阅、发布、取消订阅功能
  - 测试异常隔离和线程安全
  - _需求: 1.1, 1.2, 1.3, 1.4_

- [ ] 10. 验证现有功能完整性
  - 运行应用验证图像加载功能正常
  - 验证批处理功能正常
  - 确保没有破坏现有功能
  - _需求: 2.1, 4.1, 4.2, 4.3_