# MainWindow重构设计文档

## 概述

本设计将MainWindow的职责分解为多个专门的组件，每个组件负责特定的功能领域。通过依赖注入和事件驱动的方式，实现松耦合的架构设计。

## 架构设计

### 核心设计原则

1. **单一职责原则**：每个组件只负责一个明确的功能领域
2. **依赖注入**：通过构造函数注入必要的依赖，避免直接服务查找
3. **事件驱动**：组件间通过信号/槽机制通信，减少直接耦合
4. **最小化设计**：只创建必要的组件，避免过度设计

## 组件设计

### 1. MainWindowLayoutManager (布局管理器)

**文件路径：** `app/ui/managers/main_window_layout_manager.py`

**职责：**
- 创建和组装主窗口的UI布局
- 管理面板的显示/隐藏逻辑
- 处理布局的动态调整

**关键方法：**
- `create_layout()`: 创建完整布局
- `update_layout_for_batch_panel()`: 根据批处理面板状态调整布局

### 2. MainWindowConnectionManager (连接管理器)

**文件路径：** `app/ui/managers/main_window_connection_manager.py`

**职责：**
- 集中管理MainWindow相关的所有信号连接
- 处理服务可用性变化时的连接管理
- 提供统一的信号连接接口

**关键方法：**
- `connect_all_signals()`: 连接所有可用的信号
- `connect_service_signals()`: 连接特定服务的信号
- `handle_service_availability()`: 处理服务可用性变化

### 3. 重构后的MainWindow

**文件路径：** `app/ui/main_window.py` (重构)

**职责：**
- 作为主窗口容器和应用程序入口
- 协调布局管理器和连接管理器的工作
- 处理窗口级别的基本设置和事件
- 管理UI面板的生命周期

**简化后的结构：**
- 构造函数：基本初始化和管理器创建
- 事件方法：处理键盘、拖放、关闭事件
- 业务回调：图像加载、保存等UI响应
- 最小化的辅助方法

## 数据流设计

### 初始化流程

1. MainWindow创建 → 创建依赖的管理器
2. MainWindowLayoutManager组装UI布局
3. MainWindowConnectionManager建立信号连接
4. MainWindow准备事件处理
5. 完成初始化

### 运行时交互

1. 用户操作 → MainWindow接收事件
2. MainWindow → 直接处理或委托给管理器
3. 管理器 → 通过信号通知相关组件
4. 组件响应 → 更新UI状态

## 错误处理

### 服务不可用处理

- 使用空对象模式处理服务缺失
- 提供降级功能确保基本可用性
- 记录警告信息便于调试

### 初始化失败处理

- 分阶段初始化，失败时提供明确错误信息
- 关键组件失败时阻止启动
- 非关键组件失败时继续运行并记录警告

## 测试策略

### 单元测试重点

1. **组件创建测试**：验证各组件能正确创建和初始化
2. **信号连接测试**：验证信号连接的正确性
3. **事件处理测试**：验证事件处理的正确性
4. **布局组装测试**：验证UI布局的正确组装

### 集成测试重点

1. **组件协作测试**：验证各组件间的协作
2. **服务依赖测试**：验证服务依赖的正确处理
3. **完整初始化测试**：验证完整的初始化流程